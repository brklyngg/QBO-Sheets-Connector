<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <style>
    body {
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      padding: 16px;
      color: #202124;
    }
    h1 {
      font-size: 18px;
      margin: 0 0 12px;
    }
    h2 {
      font-size: 14px;
      margin: 16px 0 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #5f6368;
    }
    .section {
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      background: #fff;
    }
    .status-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .status-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: #e8eaed;
      color: #202124;
    }
    .status-pill.connected {
      background: #e6f4ea;
      color: #0f9d58;
      border: 1px solid #0f9d58;
    }
    .status-pill.disconnected {
      background: #fce8e6;
      color: #d93025;
      border: 1px solid #d93025;
    }
    .details {
      font-size: 12px;
      color: #5f6368;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    label {
      font-size: 12px;
      display: block;
      margin-bottom: 6px;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      margin-bottom: 12px;
    }
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background: #1a73e8;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.secondary {
      background: #e8eaed;
      color: #202124;
    }
    button.danger {
      background: #d93025;
    }
    button:disabled {
      background: #e8eaed;
      color: #9aa0a6;
      cursor: default;
    }
    .button-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .stored-value {
      font-size: 12px;
      color: #5f6368;
      margin-bottom: 12px;
    }
    .stored-value code {
      background: #f1f3f4;
      padding: 2px 4px;
      border-radius: 4px;
    }
    .info-box {
      font-size: 12px;
      background: #f8f9fa;
      border-left: 3px solid #1a73e8;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 4px;
    }
    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: #202124;
      color: #fff;
      padding: 10px 16px;
      border-radius: 6px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      font-size: 12px;
    }
    .toast.show {
      opacity: 1;
      pointer-events: auto;
    }
    .toast.error {
      background: #d93025;
    }
    .small {
      font-size: 11px;
      color: #5f6368;
    }
    .test-result {
      font-size: 12px;
      padding: 8px;
      border-radius: 4px;
      background: #f1f3f4;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h1>QuickBooks Connection Tester</h1>

  <div class="section" id="statusSection">
    <h2>Status</h2>
    <div class="status-row">
      <span id="statusPill" class="status-pill">Checking…</span>
    </div>
    <div id="statusDetails" class="details"></div>
    <div class="button-row">
      <button id="connectBtn">Connect to QuickBooks</button>
      <button id="refreshBtn" class="secondary">Refresh Status</button>
      <button id="disconnectBtn" class="danger">Disconnect</button>
    </div>
    <button id="testBtn" class="secondary" style="margin-bottom:0;">Test Company Info</button>
    <div id="testResult" class="test-result" style="display:none;"></div>
  </div>

  <div class="section">
    <h2>Credentials</h2>
    <div class="info-box">
      <strong>Redirect URI:</strong>
      <div id="redirectUri" style="word-break: break-all;"></div>
      <div class="small" style="margin-top:6px;">Add this URI to your Intuit app configuration before attempting to connect.</div>
    </div>
    <label for="clientId">Client ID</label>
    <input type="text" id="clientId" placeholder="Paste your QuickBooks Client ID">

    <label for="clientSecret">Client Secret</label>
    <input type="password" id="clientSecret" placeholder="Paste your QuickBooks Client Secret">

    <label for="environment">Environment</label>
    <select id="environment">
      <option value="sandbox">Sandbox</option>
      <option value="production">Production</option>
    </select>

    <div class="stored-value">
      Stored Client ID: <code id="storedClientId">None</code><br>
      Stored Client Secret: <code id="storedClientSecret">None</code>
    </div>

    <button id="saveBtn">Save Credentials</button>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const initialState = <?!= initialStateJson ?>;
    let state = initialState;

    const statusPill = document.getElementById('statusPill');
    const statusDetails = document.getElementById('statusDetails');
    const redirectUri = document.getElementById('redirectUri');
    const storedClientId = document.getElementById('storedClientId');
    const storedClientSecret = document.getElementById('storedClientSecret');
    const clientIdInput = document.getElementById('clientId');
    const clientSecretInput = document.getElementById('clientSecret');
    const environmentSelect = document.getElementById('environment');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const testBtn = document.getElementById('testBtn');
    const testResult = document.getElementById('testResult');
    const toast = document.getElementById('toast');

    function updateUI() {
      const status = state.status || {};
      redirectUri.textContent = state.redirectUri || '';
      storedClientId.textContent = status.hasCredentials ? status.clientId : 'None';
      storedClientSecret.textContent = status.hasCredentials ? status.clientSecret : 'None';
      environmentSelect.value = status.environment || 'sandbox';

      if (status.isConnected) {
        statusPill.textContent = 'Connected';
        statusPill.classList.remove('disconnected');
        statusPill.classList.add('connected');
        let details = 'Tokens stored for QuickBooks Online.';
        if (status.companyName) {
          details += `\nCompany: ${status.companyName}`;
        }
        if (status.realmId) {
          details += `\nRealm ID: ${status.realmId}`;
        }
        if (status.lastConnectedAt) {
          details += `\nLast connected: ${new Date(status.lastConnectedAt).toLocaleString()}`;
        }
        statusDetails.textContent = details;
      } else {
        statusPill.textContent = 'Disconnected';
        statusPill.classList.remove('connected');
        statusPill.classList.add('disconnected');
        statusDetails.textContent = 'Enter your credentials, save them, and then click Connect to start the OAuth flow.';
      }

      connectBtn.disabled = !status.hasCredentials;
      disconnectBtn.disabled = !status.isConnected;
      testBtn.disabled = !status.isConnected;
    }

    function showToast(message, isError = false) {
      toast.textContent = message;
      toast.classList.toggle('error', Boolean(isError));
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function handleError(err) {
      const message = err && err.message ? err.message : String(err);
      showToast(message, true);
    }

    document.getElementById('saveBtn').addEventListener('click', () => {
      const payload = {
        clientId: clientIdInput.value.trim(),
        clientSecret: clientSecretInput.value.trim(),
        environment: environmentSelect.value
      };

      google.script.run
        .withSuccessHandler((newStatus) => {
          state.status = newStatus;
          clientSecretInput.value = '';
          showToast('Credentials saved.');
          updateUI();
        })
        .withFailureHandler(handleError)
        .saveConnectionSettings(payload);
    });

    connectBtn.addEventListener('click', () => {
      google.script.run
        .withSuccessHandler(({ authorizationUrl }) => {
          if (!authorizationUrl) {
            showToast('Failed to create authorization URL.', true);
            return;
          }
          const popup = window.open(authorizationUrl, '_blank');
          if (!popup) {
            showToast('Allow pop-ups for this site to continue.', true);
          } else {
            showToast('Complete the QuickBooks authorization in the new tab.');
          }
        })
        .withFailureHandler(handleError)
        .startAuthorization();
    });

    refreshBtn.addEventListener('click', () => {
      google.script.run
        .withSuccessHandler((newStatus) => {
          state.status = newStatus;
          showToast('Status updated.');
          updateUI();
        })
        .withFailureHandler(handleError)
        .refreshConnectionStatus();
    });

    disconnectBtn.addEventListener('click', () => {
      google.script.run
        .withSuccessHandler((newStatus) => {
          state.status = newStatus;
          testResult.style.display = 'none';
          showToast('Disconnected from QuickBooks.');
          updateUI();
        })
        .withFailureHandler(handleError)
        .disconnectFromQuickBooks();
    });

    testBtn.addEventListener('click', () => {
      testResult.style.display = 'block';
      testResult.textContent = 'Checking…';

      google.script.run
        .withSuccessHandler((result) => {
          if (result.success) {
            testResult.textContent = `Success! ${result.companyName} (Realm ${result.realmId || 'unknown'})`;
          } else {
            testResult.textContent = `Failed: ${result.message}`;
          }
        })
        .withFailureHandler((err) => {
          testResult.textContent = err && err.message ? err.message : String(err);
        })
        .runConnectionTest();
    });

    updateUI();
  </script>
</body>
</html>
